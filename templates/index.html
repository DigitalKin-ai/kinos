{% extends "base.html" %}

{% block title %}Parallagon Web{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@6.5.95/css/materialdesignicons.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<style>
@keyframes flash-tab {
    0% { background-color: inherit; }
    50% { background-color: #fff3cd; }
    100% { background-color: inherit; }
}
.flash-tab {
    animation: flash-tab 1s ease-in-out;
}
</style>
{% endblock %}

{% block content %}
<div id="app">
    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <div class="logo">‚ö´ Parallagon</div>
            <div class="controls">
                <button class="btn-start" @click="startAgents" :disabled="running">
                    ‚ñ∂ Start
                </button>
                <button class="btn-stop" @click="stopAgents" :disabled="!running">
                    ‚ñ† Stop
                </button>
                <button class="btn-reset" @click="resetFiles" :disabled="running">
                    ‚Ü∫ Reset
                </button>
                <button class="btn-test" @click="loadTestData" :disabled="running">
                    üß™ Test
                </button>
                <span class="status" :class="{ 'status-running': running }">
                    ‚óè ${ running ? 'Running' : 'Stopped' }
                </span>
            </div>
        </div>

        <!-- Main content with sidebar tabs -->
        <div class="content-container">
            <!-- Left sidebar tabs -->
            <div class="sidebar">
                <div class="tab-item" 
                     v-for="tab in tabs" 
                     :key="tab.id"
                     :class="{ active: activeTab === tab.id }"
                     :data-tab="tab.id"
                     @click="setActiveTab(tab.id)">
                    <i :class="tab.icon"></i>
                    <span>${ tab.name }</span>
                </div>
            </div>

            <!-- Content area -->
            <div class="content-area">
                <!-- Demande content -->
                <div v-if="activeTab === 'demande'" class="panel">
                    <div class="panel-header">
                        <h2 class="panel-title">
                            <i class="mdi mdi-file-document-outline mr-2"></i>Demande
                        </h2>
                    </div>
                    <div class="panel-content">
                        <textarea v-model="content.demande"
                                 @input="onDemandeInput"
                                 class="content-area"></textarea>
                    </div>
                </div>

                <!-- Specifications content -->
                <div v-if="activeTab === 'specifications'" class="panel">
                    <div class="panel-header">
                        <h2 class="panel-title">
                            <i class="mdi mdi-file-tree mr-2"></i>Specifications
                        </h2>
                    </div>
                    <div class="panel-content">
                        <pre class="content-display" v-html="highlightContent('specifications')"></pre>
                    </div>
                </div>

                <!-- Management content -->
                <div v-if="activeTab === 'management'" class="panel">
                    <div class="panel-header">
                        <h2 class="panel-title">
                            <i class="mdi mdi-account-supervisor mr-2"></i>Management
                        </h2>
                    </div>
                    <div class="panel-content">
                        <pre class="content-display" v-html="highlightContent('management')"></pre>
                    </div>
                </div>

                <!-- Production content -->
                <div v-if="activeTab === 'production'" class="panel">
                    <div class="panel-header">
                        <h2 class="panel-title">
                            <i class="mdi mdi-code-braces mr-2"></i>Production
                        </h2>
                    </div>
                    <div class="panel-content">
                        <pre class="content-display" v-html="highlightContent('production')"></pre>
                    </div>
                </div>

                <!-- Evaluation content -->
                <div v-if="activeTab === 'evaluation'" class="panel">
                    <div class="panel-header">
                        <h2 class="panel-title">
                            <i class="mdi mdi-check-circle mr-2"></i>Evaluation
                        </h2>
                    </div>
                    <div class="panel-content">
                        <pre class="content-display" v-html="highlightContent('evaluation')"></pre>
                    </div>
                </div>

                <!-- Suivi Mission content -->
                <div v-if="activeTab === 'suivi-mission'" class="panel">
                    <div class="panel-header">
                        <h2 class="panel-title">
                            <i class="mdi mdi-console-line mr-2"></i>Suivi Mission
                        </h2>
                        <div class="panel-controls">
                            <button @click="exportLogs" class="btn-export">
                                <i class="mdi mdi-download mr-1"></i> Export
                            </button>
                            <button @click="clearLogs" class="btn-clear">
                                <i class="mdi mdi-trash-can mr-1"></i> Clear
                            </button>
                        </div>
                    </div>
                    <div class="panel-content">
                        <div class="suivi-mission-content">
                            <div v-for="log in logs"
                                 :key="log.id" 
                                 class="suivi-mission-entry"
                                 :class="log.level">
                                <span class="log-timestamp">${ log.timestamp }</span>
                                <span class="log-message" v-html="log.message"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications -->
    <div class="notifications-container">
        <transition-group name="notification">
            <div v-for="notification in notifications"
                 :key="notification.id"
                 class="notification"
                 :class="notification.type">
                <i :class="notificationIcon(notification.type)"></i>
                <span class="notification-message">${notification.message}</span>
            </div>
        </transition-group>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='app.js') }}"></script>
<script>
// Map of file names to tab IDs
const tabIds = {
    'demande.md': 'demande',
    'specifications.md': 'specifications',
    'management.md': 'management',
    'production.md': 'production',
    'evaluation.md': 'evaluation'
};

// Check for changes periodically
function checkForChanges() {
    if (!app.running) {
        console.debug('App not running, skipping change check');
        return;
    }
    
    console.debug('Checking for changes...');
    fetch('/api/changes')
        .then(response => response.json())
        .then(changes => {
            console.debug('Received changes:', changes);
            if (changes.length > 0) {
                console.debug('Processing ' + changes.length + ' changes');
            }
            changes.forEach(change => {
                console.debug('Processing change:', change);
                if (change.operation === 'flash_tab' && change.status) {
                    const tabId = tabIds[change.status];
                    if (tabId) {
                        console.debug('Flashing tab:', tabId);
                        const tab = document.querySelector(`.tab-item[data-tab="${tabId}"]`);
                        if (tab) {
                            tab.classList.remove('flash-tab');
                            void tab.offsetWidth; // Force reflow
                            tab.classList.add('flash-tab');
                            
                            setTimeout(() => {
                                tab.classList.remove('flash-tab');
                            }, 1000);
                            
                            console.debug('Tab flash animation started for:', tabId);
                        } else {
                            console.debug('Tab element not found for:', tabId);
                        }
                    } else {
                        console.debug('No matching tabId for:', change.status);
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error checking changes:', error);
            console.debug('Full error details:', error);
        });
}

// Check for changes more frequently
setInterval(checkForChanges, 500);
</script>
{% endblock %}
