{% extends "base.html" %}

{% block title %}Parallagon Web{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@6.5.95/css/materialdesignicons.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<style>
@keyframes flash-tab {
    0% { background-color: transparent; }
    50% { background-color: #ffd700; }
    100% { background-color: transparent; }
}

.flash-tab {
    animation: flash-tab 1s ease-in-out;
}

.tab-item {
    transition: background-color 0.3s ease;
    position: relative;
}

.content-display {
    height: 100%;
    overflow-y: auto;
    padding: 1rem;
}
</style>
{% endblock %}

{% block content %}
<div id="app" v-cloak>
    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <div class="logo">‚ö´ Parallagon</div>
            <div class="current-mission" v-if="currentMission">
                <span class="mission-label">Mission:</span>
                <span class="mission-name">${ currentMission.name }</span>
            </div>
            <div class="controls">
                <button 
                    :class="['control-button', running ? 'stop' : 'start']"
                    @click="running ? stopAgents() : startAgents()"
                    :disabled="loading">
                    <i :class="running ? '‚ñ†' : '‚ñ∂'"></i>
                    ${ running ? 'Stop' : 'Start' }
                </button>
                <button class="btn-reset" @click="resetFiles" :disabled="running || !currentMission">
                    <i class="mdi mdi-refresh"></i>Reset
                </button>
                <button class="btn-test" @click="loadTestData" :disabled="running || !currentMission">
                    üß™ Test
                </button>
                <span class="status" :class="{ 'status-running': running }">
                    ‚óè ${ running ? 'Running' : 'Stopped' }
                </span>
            </div>
        </div>

        <!-- Main content with sidebar tabs -->
        <div class="content-container">
            <!-- Mission selector sidebar -->
            <div class="mission-sidebar" :class="{ 'collapsed': missionSidebarCollapsed }">
                <div class="mission-sidebar-header">
                    <h2>Missions</h2>
                    <button @click="toggleMissionSidebar" class="mission-collapse-btn">
                        <i class="mdi" :class="missionSidebarCollapsed ? 'mdi-chevron-right' : 'mdi-chevron-left'"></i>
                    </button>
                </div>
                <div class="mission-create" v-if="!missionSidebarCollapsed">
                    <div v-if="!isCreatingMission" class="mission-create-actions">
                        <div @click="startCreatingMission" class="mission-create-btn">
                            <i class="mdi mdi-plus"></i>
                            <span>Cr√©er une mission</span>
                        </div>
                    </div>
                    <div v-else class="mission-create-input-container">
                        <input v-model="newMissionName" 
                               ref="newMissionInput"
                               @keyup.enter="createMission"
                               @blur="cancelCreatingMission"
                               @keyup.esc="cancelCreatingMission"
                               placeholder="Nom de la mission"
                               class="mission-create-input">
                    </div>
                </div>
                <div class="mission-list" :class="{ 'loading': loading }">
                    <div v-if="loading" class="mission-loading">
                        Chargement des missions...
                    </div>
                    <div v-else-if="missions.length === 0" class="mission-empty">
                        Aucune mission disponible
                    </div>
                    <div v-else v-for="mission in missions" 
                         :key="mission.id"
                         class="mission-item"
                         :class="{ active: currentMission?.id === mission.id }"
                         @click="selectMission(mission)">
                        <i class="mdi mdi-folder-outline"></i>
                        <span class="mission-name">${ mission.name }</span>
                    </div>
                </div>
            </div>
            <!-- Left sidebar tabs -->
            <div class="sidebar">
                <div class="tab-item" 
                     v-for="tab in tabs" 
                     :key="tab.id"
                     :class="{ active: activeTab === tab.id }"
                     :data-tab="tab.id">
                    <div class="tab-content" @click="setActiveTab(tab.id)">
                        <i :class="tab.icon"></i>
                        <span>${ tab.name }</span>
                    </div>
                    <!-- Toggle button for agent tabs -->
                    <button v-if="isAgentTab(tab.id)"
                            class="agent-toggle"
                            :class="{ 'running': isAgentRunning(tab.id) }"
                            @click.stop="toggleAgent(tab.id)"
                            :title="isAgentRunning(tab.id) ? 'Stop Agent' : 'Start Agent'">
                        <i class="mdi" :class="isAgentRunning(tab.id) ? 'mdi-stop' : 'mdi-play'"></i>
                    </button>
                </div>
            </div>

            <!-- Content area -->
            <div class="content-area">
                <!-- Demande content -->
                <div v-if="activeTab === 'demande'" class="panel">
                    <div class="panel-header">
                        <h2 class="panel-title">
                            <i class="mdi mdi-file-document-outline mr-2"></i>Demande
                        </h2>
                    </div>
                    <div class="panel-content">
                        <textarea v-model="content.demande"
                                 @input="onDemandeInput"
                                 class="content-area"></textarea>
                    </div>
                </div>

                <!-- Specifications content -->
                <div v-if="activeTab === 'specifications'" class="panel">
                    <div class="panel-header">
                        <h2 class="panel-title">
                            <i class="mdi mdi-file-tree mr-2"></i>Specifications
                        </h2>
                        <button class="btn-prompt" @click="openPromptModal('specifications')">
                            <i class="mdi mdi-text"></i>
                            Prompt
                        </button>
                    </div>
                    <div class="panel-content">
                        <div class="content-display markdown-body" v-html="formatMarkdown(highlightContent('specifications'))"></div>
                    </div>
                </div>

                <!-- Management content -->
                <div v-if="activeTab === 'management'" class="panel" data-panel="management">
                    <div class="panel-header">
                        <h2 class="panel-title">
                            <i class="mdi mdi-account-supervisor mr-2"></i>Management
                        </h2>
                        <button class="btn-prompt" @click="openPromptModal('management')">
                            <i class="mdi mdi-text"></i>
                            Prompt
                        </button>
                    </div>
                    <div class="panel-content">
                        <div class="content-display markdown-body" 
                             v-html="formatMarkdown(highlightContent('management'))"
                             :key="content.management">
                        </div>
                    </div>
                </div>

                <!-- Production content -->
                <div v-if="activeTab === 'production'" class="panel">
                    <div class="panel-header">
                        <h2 class="panel-title">
                            <i class="mdi mdi-code-braces mr-2"></i>Production
                        </h2>
                        <button class="btn-prompt" @click="openPromptModal('production')">
                            <i class="mdi mdi-text"></i>
                            Prompt
                        </button>
                    </div>
                    <div class="panel-content">
                        <div class="content-display markdown-body" v-html="formatMarkdown(highlightContent('production'))"></div>
                    </div>
                </div>

                <!-- Evaluation content -->
                <div v-if="activeTab === 'evaluation'" class="panel">
                    <div class="panel-header">
                        <h2 class="panel-title">
                            <i class="mdi mdi-check-circle mr-2"></i>Evaluation
                        </h2>
                        <button class="btn-prompt" @click="openPromptModal('evaluation')">
                            <i class="mdi mdi-text"></i>
                            Prompt
                        </button>
                    </div>
                    <div class="panel-content">
                        <div class="content-display markdown-body" v-html="formatMarkdown(highlightContent('evaluation'))"></div>
                    </div>
                </div>

                <!-- Suivi content -->
                <div v-if="activeTab === 'suivi'" class="panel">
                    <div class="panel-header">
                        <h2 class="panel-title">
                            <i class="mdi mdi-history mr-2"></i>Suivi
                        </h2>
                    </div>
                    <div class="panel-content">
                        <div class="content-display markdown-body" v-html="formatMarkdown(highlightContent('suivi'))"></div>
                    </div>
                </div>


            </div>
        </div>
    </div>

    <!-- Prompt Modal -->
    <div v-if="showPromptModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Prompt de l'agent ${currentPromptAgent}</h3>
                <button class="modal-close" @click="closePromptModal">√ó</button>
            </div>
            <div class="modal-body">
                <textarea 
                    v-model="currentPrompt"
                    class="prompt-editor"
                    @input="promptChanged = true"
                ></textarea>
            </div>
            <div class="modal-footer">
                <button 
                    class="btn-save" 
                    @click="savePrompt"
                    :disabled="!promptChanged"
                >
                    Sauvegarder
                </button>
                <button class="btn-cancel" @click="closePromptModal">
                    Annuler
                </button>
            </div>
        </div>
    </div>

    <!-- Notifications -->
    <div class="notifications-container">
        <transition-group name="notification">
            <div v-for="notification in notifications"
                 :key="notification.id"
                 class="notification"
                 :class="notification.type">
                <i :class="notificationIcon(notification.type)"></i>
                <span class="notification-message">${notification.message}</span>
            </div>
        </transition-group>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/velocity/2.0.6/velocity.min.js"></script>
<script src="{{ url_for('static', filename='app.js') }}"></script>
{% endblock %}
